{% extends "base.html" %}
 
{# replaces default content block #}
{% block content %}

<h2>Welcome to Platform 106!</h2>
{% if logged_in %}
<p>Please use the tabs above to interact with our database.</p>
{% else %}
<p>Please log in to use the platform.</p>
{% endif %}

<form id="basicSearch" method="POST" action="{{ url_for("basicSearch") }}">
    <label for="basicSearch"><input id="searchterm" placeholder="Search" name="searchterm"/></label>
    <button id="searchbutton" type="submit" name="submit" value="Search">Search</button>
</form>
    
<br>

<p><b>Featured Events! See what Wellesley students are most interested in!</b></p>

{% if featuredEvents %}
{% for post in featuredEvents %}
<div id="posts-list" class="card">
    <img src="{{ url_for('pic',pid=post.pid) }}" alt="" width="50%" class="cardimg" >
    <div id="cardContent">
        <h1 class="title"><a href="{{ url_for('displayPost',pid=post.pid) }}">{{ post.title }}</a></h1>
        
        <p class="location"><b>Location: </b>{{ post.location }}</p>
        <p class="event_date"><b>Date: </b>{{ post.event_date }}</p>
        <p class="event_time"><b>Time: </b>{{ post.event_time }}</p>
        <p class="tags"><b>Tags: </b>
            {% for tag in post.tags %}
            <a href="{{ url_for('searchTag',tag=tag) }}">{{ tag }}</a> 
            {% endfor %}
        </p>
        <p class="post_author"><b>Author: </b>{{ post.author }}</p>
        {% if logged_in %}
        <p>
            <form method="post" action="{{ url_for('starAjax') }}">
                <label class="pid"><input type="hidden" name="pid" class="pid" value="{{ post.pid }}"></label>
                <label class="starred"><input type="hidden" name="starred" class="starred" value="{{ post.starred }}"></label>
                <label class = "star-event">
                    <input type="button" name="star-event" value="{{'Starred -- Click to unstar' if post.starred == '1' else 'Star the Event'}}">
                </label>
            </form>
        </p>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endif %}


<table id="posts-list">
    <tr>
        <th>Title</th>
        <th>Location</th>
        <th>Date</th>
        <th>Time</th>
        <th>Tags</th>
        <th>Author</th>
        {% if logged_in %}
        <th>Star Status</th>
        {% endif %}
    </tr>
    {% if featuredEvents %}
    {% for post in featuredEvents %}
    <tr data-pid={{ post.pid }}>
        <td class="title"><a href="{{ url_for('displayPost',pid=post.pid) }}">{{ post.title }}</a></td> 
        <td class="location">{{ post.location }}</td>
        <td class="event_date">{{ post.event_date }}</td>
        <td class="event_time">{{ post.event_time }}</td>
        <td class="tags">
            {% for tag in post.tags %}
            <a href="{{ url_for('searchTag',tag=tag) }}">{{ tag }}</a> 
            {% endfor %}
        </td>
        <td class="post_author">{{ post.author }}</td>
        {% if logged_in %}
        <td>
            <form method="post" action="{{ url_for('starAjax') }}">
                <label class="pid"><input type="hidden" name="pid" class="pid" value="{{ post.pid }}"></label>
                <label class="starred"><input type="hidden" name="starred" class="starred" value="{{ post.starred }}"></label>
                <label class = "star-event">
                    <input type="button" name="star-event" value="{{'Starred -- Click to unstar' if post.starred == '1' else 'Star the Event'}}">
                </label>
            </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    {% endif %}
</table>

{% endblock %}

{% block jquery_scripts %}
<script>
    
    var star_URL = "{{ url_for('starAjax') }}";
    
    $("label.star-event").on("click", function (event) {
        event.preventDefault();
        var starred = $(event.target).closest("form").find("input[name='starred']").val();
        var pid = $(event.target).closest("form").find("input[name='pid']").val();
        var button = $(this).find("input[name=star-event]");
        sendStar(pid,starred,button);
    });
    
    function sendStar(pid,starred,button) {
        console.log("Sending "+pid +" and " + starred +" to the back end");
        $.post(star_URL,{'error':false, 'pid': pid, 'starred': starred},
        function(data,status){
            updateStar(data,button);
        },'json');
    }
    
    function updateStar(obj,button) {
        console.log(obj);
        if(obj.error) {
            alert(obj.err);
        } else {
            console.log("changing star status to be " + obj.starred)
            if (obj.starred == "1") {
                button.val('Starred -- Click to unstar');
            } else {
                button.val('Star the Event');
            }
            button.closest("form").find("input[name=starred]").val(obj.starred);
        }
    }


</script>

{% endblock %}