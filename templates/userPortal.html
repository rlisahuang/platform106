{% extends "base.html" %}
 
{# replaces default content block #}
{% block content %}
<h3 style="color:blue;">Hello, {{ username }}!</h3> 

<h4> Manage my Starred Posts </h4>
{% for star in stars %}
<p>---<br>
Title: <a href="{{ url_for('displayPost',pid=star['pid']) }}">{{ star['title'] }}</a><br>
Content: {{ star['content'] }}<br>
---<br>
</p>
<form method="post" action="{{ url_for('starAjax') }}">
    <label class="pid"><input type="hidden" name="pid" class="pid" value="{{ star.pid }}"></label>
    <label class="starred"><input type="hidden" name="starred" class="starred" value="{{ star.starred }}"></label>
    <label class = "star-event">
        <input type="button" name="star-event" value="{{'Starred -- Click to unstar' if star.starred == '1' else 'Star the Event'}}">
    </label>
</form>
{% endfor %}

<h4> Manage my Followed Tags </h4>
{% for follow in follows %}
<p>---
<br>
Tag: <a href="{{ url_for('searchTag',tag=follow['tag_name']) }}">{{ follow['tag_name'] }}</a>
<form method="post" action="{{ url_for('followAjax') }}">
    <input type="hidden" name="tid" class="tid" value="{{ follow.tid }}">
    <input type="hidden" name="followed" class="followed" value="{{ follow.followed }}">
    <label class = "follow-tag">
        <input type="button" name="follow-tag" value="{{'Followed -- Click to unfollow' if follow.followed == '1' else 'Follow the Tag'}}">
    </label>
</form>
---<br>
</p>
{% endfor %}

<h4> <a href=" {{url_for('updateProfile')}} ">Profile and Preferences</a> </h4>

<h4> Manage my Created Posts </h4>
{% for post in posts %}
<p>---<br>
Title: <a href="{{ url_for('displayPost',pid=post['pid']) }}">{{ post['title'] }}</a><br>
Content: {{ post['content'] }}<br>
---<br>
</p>

{% endfor %}

{% endblock %}

{% block jquery_scripts %}
<script>
    var star_URL = "{{ url_for('starAjax') }}";
    
    $("label.star-event").on("click", function (event) {
        event.preventDefault();
        var starred = $(event.target).closest("form").find("input[name='starred']").val();
        var pid = $(event.target).closest("form").find("input[name='pid']").val();
        var button = $(this).find("input[name=star-event]");
        sendStar(pid,starred,button);
    });
    
    function sendStar(pid,starred,button) {
        console.log("Sending "+pid +" and " + starred +" to the back end");
        $.post(star_URL,{'error':false, 'pid': pid, 'starred': starred},
        function(data,status){
            updateStar(data,button);
        },'json');
    }
    
    function updateStar(obj,button) {
        console.log(obj);
        if(obj.error) {
            alert(obj.err);
        } else {
            console.log("changing star status to be " + obj.starred)
            if (obj.starred == "1") {
                button.val('Starred -- Click to unstar');
            } else {
                button.val('Star the Event');
            }
            button.closest("form").find("input[name=starred]").val(obj.starred);
        }
    }

    var URL = "{{ url_for('followAjax') }}";
    
    $("label.follow-tag").on("click", function (event) {
        event.preventDefault();
        var followed = $(event.target).closest("form").find("input[name='followed']").val();
       // var followed = $(event.target).closest("form").find("input[name='followed']").is(":checked");
        console.log("follow: " + followed);
        // if(!followed) {
        // if (event.target != this) return;
            // followed = true;
        // } else {
            // followed = false;
        // }
        var tid = $(event.target).closest("form").find("input[name='tid']").val();
        var button = $(this).find("input[name=follow-tag]");
        sendFollow(tid,followed,button);
    });
    
    function sendFollow(tid,followed,button) {
        console.log("Sending "+tid +" and " + followed +" to the back end");
        $.post(URL,{'error':false, 'tid': tid, 'followed': followed},
        function(data,status){
            updateFollow(data,button);
        },'json');
    }
    
    function updateFollow(obj,button) {
        console.log(obj);
        if(obj.error) {
            // $("#errors").empty().html('Error: '+obj.err);
            alert(obj.err);
        } else {
            console.log("changing follow status to be " + obj.followed)
            if (obj.followed == "1") {
                button.val('Followed -- Click to unfollow');
            } else {
                //button.closest("form").find("input[name=followed]").prop(checked, false);
                button.val('Follow the Tag');
            }
            button.closest("form").find("input[name=followed]").val(obj.followed);
        }
    }
</script>
{% endblock %}